pipeline{
 agent none
 stages{
 stage('build'){
 agent{
 docker{
 image 'node:8.16.0-alpine'
 
 }
 }
 steps{
 echo 'building result app'
 dir('result'){
 sh 'npm install'
 }
 }
 }
 stage('test'){
 agent{
docker{
 image 'node:8.16.0-alpine'
 
 }
 }
 steps{
 echo 'running unit tests on result app'
 dir('result'){
 sh 'npm install'
 sh 'npm test' 
 }
 }
 }


 stage('docker-package'){
 agent any
 steps{
 echo 'Packaging result app with docker'
 script{
 docker.withRegistry('https://index.docker.io/v1/','dockerlogin') {
 def resultImage = docker.build("hamdymoussa/result:v${env.BUILD_ID}", "./result")
 resultImage.push()
// resultImage.push("${env.BRANCH_NAME}") 
 resultImage.push("latest")
                                                                  }
       }
      }
                       }
 stage('docker-compose-test'){
 agent any
 steps{
 echo 'Packaging result app with docker'
 sh 'docker-compose version'
      }
                       }
 }
 post{
 always{
 echo 'the job is complete'
 }
 }
}
